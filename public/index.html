<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WebRTC Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .box {
        background: #fff;
        width: 100%;
        max-width: 650px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .head {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        padding: 20px;
        text-align: center;
      }
      .head h1 {
        font-size: 22px;
      }
      .head p {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 5px;
      }
      .content {
        padding: 20px;
      }
      input {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        margin-bottom: 10px;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        transition: transform 0.2s;
      }
      button:active {
        transform: scale(0.98);
      }
      button.gray {
        background: #6c757d;
      }
      button.orange {
        background: #ff9800;
      }
      button.red {
        background: #dc3545;
      }
      .status {
        padding: 14px;
        background: #f0f2f5;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 14px;
      }
      .green {
        color: #28a745;
        font-weight: 600;
      }
      .red {
        color: #dc3545;
        font-weight: 600;
      }
      .video {
        background: #000;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        display: none;
      }
      .video.on {
        display: block;
      }
      .video video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      .tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(102, 126, 234, 0.95);
        color: #fff;
        padding: 8px 14px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 600;
        z-index: 10;
      }
      .pip-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 152, 0, 0.95);
        color: #fff;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: none;
      }
      .pip-badge.on {
        display: block;
      }
      .chat {
        background: #f0f2f5;
        padding: 15px;
        height: 350px;
        overflow-y: auto;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .m {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
        animation: slide 0.3s ease;
      }
      @keyframes slide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .m.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .m.rcv {
        align-self: flex-start;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        border-bottom-left-radius: 4px;
        color: #333;
      }
      .m strong {
        display: block;
        font-size: 12px;
        margin-bottom: 4px;
        opacity: 0.85;
      }
      .m .txt {
        display: block;
      }
      .m .time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }
      .inbox {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .inbox input {
        margin: 0;
        flex: 1;
      }
      .inbox button {
        width: 50px;
        height: 50px;
        min-width: 50px;
        border-radius: 50%;
        padding: 0;
        font-size: 20px;
      }
      .hide {
        display: none;
      }
      .users {
        margin-top: 15px;
      }
      .user {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .user:hover {
        background: #e9ecef;
      }
      .user button {
        width: auto;
        padding: 8px 16px;
        font-size: 13px;
        margin: 0;
      }
      .info {
        font-size: 12px;
        padding: 12px;
        background: #fff3cd;
        border-radius: 8px;
        margin-bottom: 10px;
        text-align: center;
        color: #856404;
        line-height: 1.6;
      }
      .warning {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #ef5350;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 2px solid #66bb6a;
      }
      .ctrl {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }
      .ctrl button {
        margin: 0;
        width: 100%;
        padding: 12px;
        font-size: 14px;
      }
      .localvid {
        width: 120px;
        height: 90px;
        background: #000;
        border-radius: 8px;
        position: fixed;
        bottom: 100px;
        right: 20px;
        z-index: 100;
        border: 3px solid #667eea;
        display: none;
      }
      .localvid.on {
        display: block;
      }
      .localvid video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
      }
      @media (max-width: 600px) {
        .box {
          max-width: 100%;
        }
        .chat {
          height: 280px;
        }
        .m {
          max-width: 85%;
          font-size: 13px;
        }
        .localvid {
          width: 100px;
          height: 75px;
          bottom: 80px;
          right: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div class="head">
        <h1>üöÄ WebRTC Chat + PiP</h1>
        <p>üîí Encrypted ‚Ä¢ Background Video Support</p>
      </div>
      <div class="content">
        <div id="login">
          <input
            type="text"
            id="user"
            placeholder="Your username (e.g., john123)"
          />
          <button onclick="login()">Connect to Server</button>
          <div class="info">üí° Choose a unique username</div>
        </div>

        <div id="select" class="hide">
          <div class="status">
            <span class="green">‚úÖ You're Online as <b id="me"></b></span>
          </div>
          <input
            type="text"
            id="friend"
            placeholder="Enter friend's username"
          />
          <button onclick="connect()">Check & Connect</button>
          <div id="userlist" class="users hide"></div>
        </div>

        <div id="chatbox" class="hide">
          <div class="status" id="stat">‚è≥ Connecting...</div>

          <div id="pipInfo" class="info success hide">
            ‚úÖ <strong>Picture-in-Picture Available!</strong><br />
            Click the PiP button below to keep video running when you minimize
            the app.
          </div>

          <div id="mobileWarn" class="info warning hide">
            ‚ö†Ô∏è <strong>Mobile Users:</strong><br />
            Camera pauses when app is minimized. Use Picture-in-Picture mode to
            keep it active!
          </div>

          <div id="vid" class="video">
            <video id="v" autoplay playsinline muted></video>
            <div class="pip-badge" id="pipBadge">üì∫ PiP Active</div>
            <div class="tag" id="tag">üìπ Live</div>
          </div>

          <!-- Local video preview (for guest) -->
          <div id="localvid" class="localvid">
            <video id="localv" autoplay playsinline muted></video>
          </div>

          <div id="camctrl" class="ctrl hide">
            <button onclick="togglePiP()" class="orange" id="pipBtn">
              üì± Enable PiP
            </button>
            <button onclick="stopCam()" class="red">‚èπ Stop Camera</button>
          </div>

          <div class="chat" id="msgs"></div>
          <div class="inbox">
            <input
              type="text"
              id="txt"
              placeholder="Type a message..."
              onkeypress="if(event.key==='Enter')send()"
            />
            <button onclick="send()">‚û§</button>
          </div>
          <button class="gray" onclick="disc()" style="margin-top: 10px">
            Disconnect
          </button>
        </div>
      </div>
    </div>

    <script>
      let ws,
        pc,
        dc,
        me,
        fr,
        stream,
        iceQueue = [],
        wakeLock = null,
        isPiPActive = false;

      const ice = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      const wsUrl = (() => {
        const isLocal =
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1";
        if (isLocal) return "ws://localhost:8080";
        const proto = location.protocol === "https:" ? "wss" : "ws";
        return `${proto}://${location.host}`;
      })();

      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      // Check PiP support
      const pipSupported = "pictureInPictureEnabled" in document;
      console.log("PiP Supported:", pipSupported);

      // Wake Lock API
      async function requestWakeLock() {
        if ("wakeLock" in navigator) {
          try {
            wakeLock = await navigator.wakeLock.request("screen");
            console.log("‚úÖ Wake Lock active");
            wakeLock.addEventListener("release", () => {
              console.log("Wake Lock released");
              wakeLock = null;
            });
          } catch (e) {
            console.log("Wake Lock error:", e);
          }
        }
      }

      function releaseWakeLock() {
        if (wakeLock) {
          wakeLock.release();
          wakeLock = null;
        }
      }

      // Toggle Picture-in-Picture
      async function togglePiP() {
        const video = document.getElementById("v");

        if (!pipSupported) {
          alert(
            "‚ùå Picture-in-Picture is not supported on this browser.\n\nTry:\n‚Ä¢ Chrome on Android\n‚Ä¢ Chrome/Edge on Desktop\n‚Ä¢ Safari on macOS"
          );
          return;
        }

        try {
          if (document.pictureInPictureElement) {
            // Exit PiP
            await document.exitPictureInPicture();
            isPiPActive = false;
            document.getElementById("pipBadge").classList.remove("on");
            document.getElementById("pipBtn").textContent = "üì± Enable PiP";
            document.getElementById("pipBtn").classList.remove("gray");
            document.getElementById("pipBtn").classList.add("orange");
          } else {
            // Enter PiP
            if (!video.srcObject) {
              alert("‚ùå No video stream available yet");
              return;
            }

            await video.requestPictureInPicture();
            isPiPActive = true;
            document.getElementById("pipBadge").classList.add("on");
            document.getElementById("pipBtn").textContent = "üì∫ Exit PiP";
            document.getElementById("pipBtn").classList.remove("orange");
            document.getElementById("pipBtn").classList.add("gray");

            // Show success message
            if (isMobile) {
              setTimeout(() => {
                alert(
                  '‚úÖ PiP Active!\n\nYou can now:\n‚Ä¢ Minimize this app\n‚Ä¢ Switch to other apps\n‚Ä¢ Camera will keep working!\n\nClick "Exit PiP" button to return to normal view.'
                );
              }, 500);
            }
          }
        } catch (e) {
          console.error("PiP error:", e);
          alert(
            "‚ùå Could not activate Picture-in-Picture.\n\nMake sure:\n‚Ä¢ Video is playing\n‚Ä¢ Browser supports PiP\n‚Ä¢ You have permission"
          );
        }
      }

      // Monitor PiP status
      if (pipSupported) {
        document.addEventListener("enterpictureinpicture", () => {
          console.log("‚úÖ Entered PiP mode");
          isPiPActive = true;
          document.getElementById("pipBadge").classList.add("on");
        });

        document.addEventListener("leavepictureinpicture", () => {
          console.log("‚ùå Left PiP mode");
          isPiPActive = false;
          document.getElementById("pipBadge").classList.remove("on");
          document.getElementById("pipBtn").textContent = "üì± Enable PiP";
          document.getElementById("pipBtn").classList.remove("gray");
          document.getElementById("pipBtn").classList.add("orange");
        });
      }

      // Monitor page visibility
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          console.log("‚ö†Ô∏è Page hidden");
          if (!isPiPActive && stream) {
            console.log("‚ö†Ô∏è Camera may pause - no PiP active");
          }
        } else {
          console.log("‚úÖ Page visible");
          if (!wakeLock) requestWakeLock();
        }
      });

      function login() {
        me = document.getElementById("user").value.trim().toLowerCase();
        if (!me) return alert("Enter username");

        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          console.log("‚úÖ Connected to server");
          ws.send(JSON.stringify({ type: "register", username: me }));
        };
        ws.onmessage = handle;
        ws.onerror = () =>
          alert("‚ùå Cannot connect to server. Make sure it's running!");
        ws.onclose = () => console.log("Disconnected");
      }

      function handle(e) {
        const d = JSON.parse(e.data);

        if (d.type === "registered") {
          hide("login");
          show("select");
          document.getElementById("me").textContent = me;
          ws.send(JSON.stringify({ type: "get-online-users" }));
        } else if (d.type === "status") {
          if (d.online) {
            document.getElementById("stat").innerHTML =
              '<span class="green">‚úÖ ' +
              d.friend +
              " is online - connecting...</span>";
            makeOffer(d.friend);
          } else {
            document.getElementById("stat").innerHTML =
              '<span class="red">‚≠ï ' + d.friend + " is offline</span>";
            setTimeout(
              () =>
                alert(
                  d.friend + " is not online. They need to open the app first."
                ),
              100
            );
          }
        } else if (d.type === "offer") {
          fr = d.from;
          getOffer(d.offer, d.from);
        } else if (d.type === "answer") getAnswer(d.answer);
        else if (d.type === "ice-candidate") {
          if (pc) {
            if (pc.remoteDescription) {
              pc.addIceCandidate(new RTCIceCandidate(d.candidate)).catch((e) =>
                console.log("ICE:", e)
              );
            } else {
              iceQueue.push(d.candidate);
            }
          }
        } else if (d.type === "online-users") showUsers(d.users);
      }

      function connect() {
        fr = document.getElementById("friend").value.trim().toLowerCase();
        if (!fr) return alert("Enter friend username");
        if (fr === me) return alert("Cannot connect to yourself!");
        hide("select");
        show("chatbox");
        ws.send(JSON.stringify({ type: "check-online", friend: fr }));
      }

      async function makeOffer(to) {
        pc = new RTCPeerConnection(ice);
        iceQueue = [];
        dc = pc.createDataChannel("chat");
        setupDC();

        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("audio", { direction: "recvonly" });

        pc.ontrack = (e) => {
          console.log("‚úÖ Received remote stream");
          const video = document.getElementById("v");
          video.srcObject = e.streams[0];
          document.getElementById("vid").classList.add("on");
          document.getElementById("tag").textContent = "üìπ " + to;

          // Show PiP info for host
          if (pipSupported) {
            document.getElementById("pipInfo").classList.remove("hide");
            document.getElementById("camctrl").classList.remove("hide");
          }
          if (isMobile)
            document.getElementById("mobileWarn").classList.remove("hide");
        };

        pc.onicecandidate = (e) => {
          if (e.candidate)
            ws.send(
              JSON.stringify({
                type: "ice-candidate",
                candidate: e.candidate,
                to,
              })
            );
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", offer, to, from: me }));
      }

      async function getOffer(offer, from) {
        hide("select");
        show("chatbox");
        document.getElementById("stat").innerHTML =
          '<span class="green">‚úÖ Connecting with ' + from + "...</span>";

        pc = new RTCPeerConnection(ice);
        iceQueue = [];

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
            audio: true,
          });

          // Show local preview
          document.getElementById("localv").srcObject = stream;
          document.getElementById("localvid").classList.add("on");

          stream.getTracks().forEach((t) => {
            pc.addTrack(t, stream);
            // Keep track enabled
            t.enabled = true;
          });

          console.log("‚úÖ Camera accessed");
          document.getElementById("camctrl").classList.remove("hide");

          if (pipSupported)
            document.getElementById("pipInfo").classList.remove("hide");
          if (isMobile) {
            document.getElementById("mobileWarn").classList.remove("hide");
            await requestWakeLock();
          }
        } catch (e) {
          console.error("Camera error:", e);
          alert(
            "‚ùå Camera permission denied.\n\nPlease:\n1. Allow camera access\n2. Use HTTPS (not HTTP)\n3. Refresh and try again"
          );
        }

        pc.ondatachannel = (e) => {
          dc = e.channel;
          setupDC();
        };
        pc.onicecandidate = (e) => {
          if (e.candidate)
            ws.send(
              JSON.stringify({
                type: "ice-candidate",
                candidate: e.candidate,
                to: from,
              })
            );
        };

        await pc.setRemoteDescription(offer);
        iceQueue.forEach((c) =>
          pc
            .addIceCandidate(new RTCIceCandidate(c))
            .catch((e) => console.log(e))
        );
        iceQueue = [];

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer, to: from, from: me }));
      }

      async function getAnswer(answer) {
        await pc.setRemoteDescription(answer);
        iceQueue.forEach((c) =>
          pc
            .addIceCandidate(new RTCIceCandidate(c))
            .catch((e) => console.log(e))
        );
        iceQueue = [];
      }

      function setupDC() {
        dc.onopen = () => {
          console.log("‚úÖ Data channel open");
          document.getElementById("stat").innerHTML =
            '<span class="green">‚úÖ Connected with ' + fr + "</span>";
        };
        dc.onmessage = (e) => {
          msg(e.data, "rcv", fr);
          if (navigator.vibrate) navigator.vibrate(50);
        };
        dc.onclose = () =>
          (document.getElementById("stat").innerHTML =
            '<span class="red">‚≠ï Disconnected</span>');
      }

      function send() {
        const input = document.getElementById("txt");
        const t = input.value.trim();
        if (!t || !dc || dc.readyState !== "open") return;
        dc.send(t);
        msg(t, "sent", "You");
        input.value = "";
        input.focus();
      }

      function msg(txt, type, name) {
        const m = document.createElement("div");
        m.className = "m " + type;
        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        m.innerHTML =
          "<strong>" +
          name +
          '</strong><span class="txt">' +
          esc(txt) +
          '</span><span class="time">' +
          time +
          "</span>";
        const chat = document.getElementById("msgs");
        chat.appendChild(m);
        chat.scrollTop = chat.scrollHeight;
      }

      function showUsers(users) {
        const list = document.getElementById("userlist");
        if (users.length === 0) {
          list.classList.add("hide");
          return;
        }
        list.classList.remove("hide");
        list.innerHTML =
          '<h3 style="font-size:15px;margin:15px 0 10px">Online (' +
          users.length +
          "):</h3>";
        users.forEach((u) => {
          const div = document.createElement("div");
          div.className = "user";
          div.innerHTML =
            '<span><span style="color:#28a745">‚óè</span> ' +
            u +
            "</span><button onclick=\"quick('" +
            u +
            "')\">Connect</button>";
          list.appendChild(div);
        });
      }

      function quick(u) {
        document.getElementById("friend").value = u;
        connect();
      }

      function stopCam() {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
          document.getElementById("localvid").classList.remove("on");
          document.getElementById("camctrl").classList.add("hide");
          releaseWakeLock();
          if (isPiPActive) document.exitPictureInPicture();
          alert("Camera stopped");
        }
      }

      function disc() {
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
        releaseWakeLock();
        if (isPiPActive) document.exitPictureInPicture();
        document.getElementById("vid").classList.remove("on");
        document.getElementById("localvid").classList.remove("on");
        document.getElementById("msgs").innerHTML = "";
        document.getElementById("mobileWarn").classList.add("hide");
        document.getElementById("pipInfo").classList.add("hide");
        hide("chatbox");
        show("select");
        ws.send(JSON.stringify({ type: "get-online-users" }));
      }

      function hide(id) {
        document.getElementById(id).classList.add("hide");
      }
      function show(id) {
        document.getElementById(id).classList.remove("hide");
      }
      function esc(t) {
        const d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
      }

      window.onbeforeunload = () => {
        releaseWakeLock();
        if (ws) ws.close();
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
      };
    </script>
  </body>
</html>
