<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Chat Test</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Fixes favicon 404 -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0d1418; color: #e4e7ea; height: 100vh; overflow: hidden; }
    #entry { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; gap: 20px; }
    input, select, button { padding: 15px; border: none; border-radius: 25px; font-size: 16px; width: 280px; max-width: 90vw; }
    input { background: #202c33; color: #e4e7ea; }
    button { background: #00d4aa; color: #000; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #00bf94; }
    button:disabled { background: #404c55; cursor: not-allowed; }
    #lobby, #chat { display: none; height: 100vh; flex-direction: column; }
    #lobby { background: #0d1418; }
    #users { flex: 1; padding: 20px; overflow-y: auto; }
    .user { display: flex; align-items: center; gap: 15px; padding: 15px; background: #202c33; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .user:hover { background: #2a3942; }
    .user.admin { border-left: 4px solid #00d4aa; }
    .user.user { border-left: 4px solid #f79b4f; }
    .status { font-size: 12px; opacity: 0.7; }
    #chat { background: #0d1418; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,0.02) 20px); }
    #video-admin { display: none; width: 100%; height: 200px; background: #000; border-radius: 0 0 20px 20px; object-fit: cover; }
    #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; }
    .message.sent { align-self: flex-end; background: #00d4aa; color: #000; border-bottom-right-radius: 4px; }
    .message.received { align-self: flex-start; background: #2a3942; border-bottom-left-radius: 4px; }
    .input-group { padding: 20px; display: flex; gap: 10px; background: #161f27; }
    #messageInput { flex: 1; }
    .online-dot { width: 10px; height: 10px; background: #00d4aa; border-radius: 50%; animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 80%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="entry">
    <h1>Student Chat Test</h1>
    <input id="nameInput" placeholder="Enter your name" value="">
    <select id="roleSelect">
      <option value="user">User (Student)</option>
      <option value="admin">Admin (Teacher)</option>
    </select>
    <input id="adminPass" class="hidden" type="password" placeholder="Admin Password">
    <button id="joinBtn">Join Lobby</button>
  </div>
  <div id="lobby">
    <div style="padding: 20px; background: #161f27; border-bottom: 1px solid #2a3942;">
      <span id="currentUser"></span> | <span id="status">Connecting...</span>
    </div>
    <div id="users"></div>
  </div>
  <div id="chat">
    <video id="video-admin" autoplay playsinline muted></video>
    <div id="messages"></div>
    <div class="input-group">
      <input id="messageInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    (function() {  // IIFE fixes scope issues [memory:3]
      const ADMIN_PASS = 'admin123'; // Change this
      const WS_URL = window.location.hostname === 'localhost' ? 'ws://localhost:8080' : `wss://${window.location.host}`;
      let ws, myId = crypto.randomUUID(), name, role, peer = null, dataChannel = null, currentRoom = null;
      
      const entry = document.getElementById('entry');
      const lobby = document.getElementById('lobby');
      const chat = document.getElementById('chat');
      const nameInput = document.getElementById('nameInput');
      const roleSelect = document.getElementById('roleSelect');
      const adminPass = document.getElementById('adminPass');
      const joinBtn = document.getElementById('joinBtn');

      // Load saved name
      const savedName = localStorage.getItem('chatName');
      if (savedName) nameInput.value = savedName;

      roleSelect.onchange = () => adminPass.classList.toggle('hidden', roleSelect.value !== 'admin');
      
      joinBtn.onclick = joinLobby;

      window.joinLobby = joinLobby;  // Global fallback
      window.sendMessage = sendMessage;

      function joinLobby() {
        name = nameInput.value.trim() || 'Anonymous';
        role = roleSelect.value;
        if (!name) return alert('Enter name');
        localStorage.setItem('chatName', name);
        if (role === 'admin' && adminPass.value !== ADMIN_PASS) return alert('Wrong password!');
        entry.style.display = 'none';
        lobby.style.display = 'flex';
        document.getElementById('currentUser').textContent = `${role === 'admin' ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ User'}: ${name}`;
        connectWS();
      }

      function connectWS() {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
          ws.send(JSON.stringify({type: 'register', id: myId, name, role}));
          document.getElementById('status').textContent = 'Online';
        };
        ws.onclose = () => document.getElementById('status').textContent = 'Disconnected';
        ws.onerror = () => document.getElementById('status').textContent = 'Connection failed';
        ws.onmessage = handleMessage;
      }

      function handleMessage(e) {
        try {
          const msg = JSON.parse(e.data);
          if (msg.type === 'userlist') {
            updateUserList(msg.users.filter(u => u.id !== myId));
          } else if (msg.type === 'connect-response') {
            currentRoom = msg.room;
            if (role === 'admin') initPeer(true); else initPeer(false);
          } else if (msg.type === 'webrtc') {
            handleWebRTC(msg);
          }
        } catch(err) { console.error('Msg error:', err); }
      }

      function updateUserList(users) {
        const container = document.getElementById('users');
        container.innerHTML = users.map(u => {
          const clickable = role === 'admin' && u.role === 'user' ? `onclick="requestConnect('${u.id}')"` : 'style="opacity:0.5;cursor:default" title="Users cannot connect"';
          return `<div class="user ${u.role}" ${clickable}>
            <div class="online-dot"></div>
            <strong>${u.name}</strong>
            <span class="status">${u.role === 'admin' ? 'ðŸ‘‘ Teacher' : 'ðŸ‘¤ Student'}</span>
          </div>`;
        }).join('');
        document.getElementById('status').textContent = `${users.length} online`;
      }

      function requestConnect(toId) {
        ws.send(JSON.stringify({type: 'connect-request', fromId: myId, toId}));
      }

      const rtcConfig = {
        iceServers: [
          {urls: 'stun:stun.l.google.com:19302'},
          {urls: 'stun:stun1.l.google.com:19302'},
          { // Fixed TURN syntax [web:28]
            urls: ['turn:openrelay.metered.ca:80', 'turn:openrelay.metered.ca:443', 'turn:openrelay.metered.ca:443?transport=tcp'],
            username: 'openrelayproject',
            credential: 'openrelayproject',
            credentialType: 'password'
          }
        ]
      };

      async function initPeer(isAdmin) {
        peer = new RTCPeerConnection(rtcConfig);
        
        if (!isAdmin) {
          // Student: share camera continuously
          try {
            const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}, audio: false});
            stream.getTracks().forEach(track => peer.addTrack(track, stream));
          } catch(e) {
            alert('Camera access required for students');
            return;
          }
        }
        
        peer.ondatachannel = (e) => {
          dataChannel = e.channel;
          setupDataChannel();
        };
        
        if (isAdmin) {
          dataChannel = peer.createDataChannel('chat');
          setupDataChannel();
          peer.ontrack = (e) => {
            const vid = document.getElementById('video-admin');
            vid.srcObject = e.streams[0];
            vid.onloadedmetadata = () => vid.play();
            vid.style.display = 'block';
          };
        }
        
        peer.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(JSON.stringify({type: 'webrtc', fromId: myId, candidate: e.candidate, room: currentRoom}));
          }
        };
        
        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        ws.send(JSON.stringify({type: 'webrtc', fromId: myId, sdp: peer.localDescription, room: currentRoom}));
        
        lobby.style.display = 'none';
        chat.style.display = 'flex';
      }

      function setupDataChannel() {
        dataChannel.onopen = () => console.log('âœ… Chat connected');
        dataChannel.onmessage = (e) => addMessage(e.data, false);
        dataChannel.onclose = () => console.log('Chat disconnected');
      }

      function handleWebRTC(msg) {
        if (!peer) return;
        if (msg.candidate) {
          peer.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
        if (msg.sdp) {
          peer.setRemoteDescription(new RTCSessionDescription(msg.sdp)).then(async () => {
            if (msg.sdp.type === 'offer') {
              const answer = await peer.createAnswer();
              await peer.setLocalDescription(answer);
              ws.send(JSON.stringify({type: 'webrtc', fromId: myId, sdp: peer.localDescription, room: currentRoom}));
            }
          }).catch(console.error);
        }
      }

      function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text || !dataChannel || dataChannel.readyState !== 'open') return;
        dataChannel.send(text);
        addMessage(text, true);
        input.value = '';
      }

      function addMessage(text, sent) {
        const div = document.createElement('div');
        div.className = `message ${sent ? 'sent' : 'received'}`;
        div.textContent = text;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      }

      // Enter to send
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    })();
  </script>
</body>
</html>
