<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WebRTC Secure Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .box {
        background: #fff;
        width: 100%;
        max-width: 650px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .head {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        padding: 20px;
        text-align: center;
        position: relative;
      }
      .head h1 {
        font-size: 22px;
      }
      .head p {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 5px;
      }
      .logout-btn {
        /* position: absolute;
        top: 20px;
        right: 20px; */
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.4);
        color: #fff;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
      }
      .logout-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.05);
      }
      .content {
        padding: 20px;
      }
      input {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        margin-bottom: 10px;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        transition: transform 0.2s;
      }
      button:active {
        transform: scale(0.98);
      }
      button.gray {
        background: #6c757d;
      }
      button.red {
        background: #dc3545;
      }
      .status {
        padding: 14px;
        background: #f0f2f5;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 14px;
      }
      .green {
        color: #28a745;
        font-weight: 600;
      }
      .red {
        color: #dc3545;
        font-weight: 600;
      }
      .video {
        background: #000;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        display: none;
      }
      .video.on {
        display: block;
      }
      .video video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      .tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(102, 126, 234, 0.95);
        color: #fff;
        padding: 8px 14px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 600;
        z-index: 10;
      }
      .chat {
        background: #f0f2f5;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .date-sep {
        text-align: center;
        color: #666;
        font-size: 12px;
        margin: 10px 0;
        font-weight: 600;
      }
      .m {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
        animation: slide 0.3s ease;
      }
      @keyframes slide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .m.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .m.rcv {
        align-self: flex-start;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        border-bottom-left-radius: 4px;
        color: #333;
      }
      .m strong {
        display: block;
        font-size: 12px;
        margin-bottom: 4px;
        opacity: 0.85;
      }
      .m .txt {
        display: block;
      }
      .m .time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }
      .inbox {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .inbox input {
        margin: 0;
        flex: 1;
      }
      .inbox button {
        width: 50px;
        height: 50px;
        min-width: 50px;
        border-radius: 50%;
        padding: 0;
        font-size: 20px;
      }
      .hide {
        display: none;
      }
      .users-container {
        margin-top: 10px;
      }
      .users-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .user-card {
        padding: 14px 16px;
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .user-card:hover {
        border-color: #667eea;
        background: #f8f9ff;
        transform: translateX(4px);
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .online-dot {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .user-name {
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }
      .user-status {
        font-size: 12px;
        color: #28a745;
        font-weight: 500;
      }
      .connect-arrow {
        color: #667eea;
        font-size: 20px;
        font-weight: bold;
      }
      .info {
        font-size: 12px;
        padding: 12px;
        background: #fff3cd;
        border-radius: 8px;
        margin-bottom: 10px;
        text-align: center;
        color: #856404;
        line-height: 1.6;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 2px solid #66bb6a;
      }
      .ctrl {
        display: none;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: center;
      }
      .ctrl button {
        width: auto;
        padding: 10px 16px;
      }
      .history-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 12px;
        color: #1565c0;
      }
      .history-info button {
        background: #1976d2;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        width: auto;
        margin: 0;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }
      .empty-state p {
        font-size: 14px;
        margin-top: 10px;
      }
      @media (max-width: 600px) {
        .box {
          max-width: 100%;
        }
        .chat {
          height: 300px;
        }
        .m {
          max-width: 85%;
          font-size: 13px;
        }
        .logout-btn {
          position: static;
          margin-top: 10px;
          width: auto;
          display: inline-block;
        }
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div class="head">
        <h1>üöÄ WebRTC Secure Chat</h1>
        <p>üîí End-to-End Encrypted ‚Ä¢ Chat History Saved</p>
        <button class="logout-btn hide" id="logoutBtn" onclick="logout()">‚Ü© Change User</button>
      </div>
      <div class="content">
        <!-- Login Screen -->
        <div id="login">
          <input
            type="text"
            id="user"
            placeholder="Your username (e.g., john123)"
            onkeypress="if(event.key==='Enter')login()"
          />
          <button onclick="login()">Connect to Server</button>
          <div class="info">
            üí° Your username will be remembered on this device
          </div>
        </div>

        <!-- User Selection Screen -->
        <div id="select" class="hide">
          <div class="status">
            <span class="green">‚úÖ You're Online as <b id="me"></b></span>
          </div>
          
          <div id="usersContainer" class="users-container">
            <div class="users-header">
              <span>üë• Online Users</span>
              <span style="font-size:12px;color:#999;font-weight:400" id="refreshTime"></span>
            </div>
            <div id="userlist"></div>
          </div>
        </div>

        <!-- Chat Screen -->
        <div id="chatbox" class="hide">
          <div class="status" id="stat">‚è≥ Connecting...</div>

          <div id="historyInfo" class="history-info hide">
            <span>üíæ <b id="msgCount">0</b> messages saved</span>
            <button onclick="clearHistory()">Clear History</button>
          </div>

          <div id="vid" class="video">
            <video id="v" autoplay playsinline></video>
            <div class="tag" id="tag">üîπ Live</div>
          </div>

          <div id="camctrl" class="ctrl hide">
            <button onclick="stopCam()" class="red">‚èπ Stop Camera</button>
          </div>

          <div class="chat" id="msgs"></div>
          <div class="inbox">
            <input
              type="text"
              id="txt"
              placeholder="Type a message..."
              onkeypress="if(event.key==='Enter')send()"
            />
            <button onclick="send()">‚û§</button>
          </div>
          <button class="gray" onclick="disc()" style="margin-top: 10px">
            ‚Üê Back to Users
          </button>
        </div>
      </div>
    </div>

    <script>
      let ws, pc, dc, me, fr, stream, iceQueue = [];
      let onlineUsers = [];
      let refreshInterval;

      const ice = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          { urls: "stun:stun2.l.google.com:19302" },
        ],
      };

      const wsUrl = (() => {
        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        if (isLocal) return "ws://localhost:8080";
        const proto = location.protocol === "https:" ? "wss" : "ws";
        return `${proto}://${location.host}`;
      })();

      // Encryption functions
      function simpleEncrypt(text, key) {
        let result = "";
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return btoa(result);
      }

      function simpleDecrypt(encrypted, key) {
        try {
          const decoded = atob(encrypted);
          let result = "";
          for (let i = 0; i < decoded.length; i++) {
            result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
          }
          return result;
        } catch (e) {
          return null;
        }
      }

      function getEncryptionKey() {
        let key = localStorage.getItem("_ek");
        if (!key) {
          key = Math.random().toString(36).substring(2) + Date.now().toString(36);
          localStorage.setItem("_ek", key);
        }
        return key;
      }

      const encKey = getEncryptionKey();

      // Save/Load message history
      function saveMessage(friend, message, type) {
        const chatKey = `chat_${me}_${friend}`;
        let history = [];

        try {
          const stored = localStorage.getItem(chatKey);
          if (stored) {
            const decrypted = simpleDecrypt(stored, encKey);
            if (decrypted) history = JSON.parse(decrypted);
          }
        } catch (e) {
          console.log("History load error");
        }

        history.push({ msg: message, type: type, time: Date.now() });
        if (history.length > 500) history = history.slice(-500);

        try {
          const encrypted = simpleEncrypt(JSON.stringify(history), encKey);
          localStorage.setItem(chatKey, encrypted);
        } catch (e) {
          console.log("History save error");
        }

        updateMessageCount();
      }

      function loadHistory(friend) {
        const chatKey = `chat_${me}_${friend}`;

        try {
          const stored = localStorage.getItem(chatKey);
          if (!stored) return;

          const decrypted = simpleDecrypt(stored, encKey);
          if (!decrypted) return;

          const history = JSON.parse(decrypted);

          if (history.length > 0) {
            const sep = document.createElement("div");
            sep.className = "date-sep";
            sep.textContent = "üìú Previous Messages";
            document.getElementById("msgs").appendChild(sep);

            const recent = history.slice(-50);
            recent.forEach((item) => {
              displayMessage(item.msg, item.type, item.type === "sent" ? "You" : friend, item.time, false);
            });

            const sep2 = document.createElement("div");
            sep2.className = "date-sep";
            sep2.textContent = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ New Messages ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
            document.getElementById("msgs").appendChild(sep2);
          }

          updateMessageCount();
        } catch (e) {
          console.log("History load failed");
        }
      }

      function updateMessageCount() {
        if (!me || !fr) return;
        const chatKey = `chat_${me}_${fr}`;

        try {
          const stored = localStorage.getItem(chatKey);
          if (stored) {
            const decrypted = simpleDecrypt(stored, encKey);
            if (decrypted) {
              const history = JSON.parse(decrypted);
              document.getElementById("msgCount").textContent = history.length;
              document.getElementById("historyInfo").classList.remove("hide");
            }
          }
        } catch (e) {}
      }

      function clearHistory() {
        if (!confirm("Delete all chat history with " + fr + "?\n\nThis cannot be undone!")) return;

        const chatKey = `chat_${me}_${fr}`;
        localStorage.removeItem(chatKey);
        document.getElementById("msgs").innerHTML = "";
        document.getElementById("msgCount").textContent = "0";
        alert("‚úÖ Chat history deleted");
      }

      // Auto-login on page load
      window.onload = () => {
        const savedUsername = localStorage.getItem("saved_username");
        if (savedUsername) {
          document.getElementById("user").value = savedUsername;
          // Auto-login after small delay
          setTimeout(() => login(), 300);
        }
      };

      function login() {
        me = document.getElementById("user").value.trim().toLowerCase();
        if (!me) return alert("Enter username");

        // Save username for next time
        localStorage.setItem("saved_username", me);

        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          console.log("‚úÖ Connected");
          ws.send(JSON.stringify({ type: "register", username: me }));
        };
        ws.onmessage = handle;
        ws.onerror = () => alert("‚ùå Cannot connect to server");
        ws.onclose = () => {
          console.log("Disconnected");
          clearInterval(refreshInterval);
        };
      }

      function logout() {
        if (!confirm("Logout and change username?")) return;
        
        localStorage.removeItem("saved_username");
        
        if (ws) ws.close();
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
        
        clearInterval(refreshInterval);
        
        hide("select");
        hide("chatbox");
        show("login");
        document.getElementById("logoutBtn").classList.add("hide");
        document.getElementById("user").value = "";
        
        location.reload();
      }

      function handle(e) {
        const d = JSON.parse(e.data);

        if (d.type === "registered") {
          hide("login");
          show("select");
          document.getElementById("me").textContent = me;
          document.getElementById("logoutBtn").classList.remove("hide");
          
          // Request online users immediately
          ws.send(JSON.stringify({ type: "get-online-users" }));
          
          // Auto-refresh online users every 5 seconds
          refreshInterval = setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: "get-online-users" }));
            }
          }, 5000);
          
        } else if (d.type === "status") {
          if (d.online) {
            document.getElementById("stat").innerHTML = '<span class="green">‚úÖ ' + d.friend + " is online - connecting...</span>";
            makeOffer(d.friend);
          } else {
            document.getElementById("stat").innerHTML = '<span class="red">‚≠ï ' + d.friend + " is offline</span>";
            setTimeout(() => alert(d.friend + " is not online"), 100);
          }
        } else if (d.type === "offer") {
          fr = d.from;
          getOffer(d.offer, d.from);
        } else if (d.type === "answer") {
          getAnswer(d.answer);
        } else if (d.type === "ice-candidate") {
          if (pc) {
            if (pc.remoteDescription) {
              pc.addIceCandidate(new RTCIceCandidate(d.candidate)).catch((e) => console.log("ICE:", e));
            } else {
              iceQueue.push(d.candidate);
            }
          }
        } else if (d.type === "online-users") {
          onlineUsers = d.users;
          showUsers(d.users);
        }
      }

      function showUsers(users) {
        const list = document.getElementById("userlist");
        
        // Update refresh time
        const now = new Date();
        document.getElementById("refreshTime").textContent = "Updated " + now.toLocaleTimeString();
        
        if (users.length === 0) {
          list.innerHTML = '<div class="empty-state">üò¥<p>No other users online right now</p></div>';
          return;
        }

        list.innerHTML = "";
        users.forEach((u) => {
          const card = document.createElement("div");
          card.className = "user-card";
          card.onclick = () => connectToUser(u);
          
          card.innerHTML = `
            <div class="user-info">
              <div class="online-dot"></div>
              <div>
                <div class="user-name">${u}</div>
                <div class="user-status">Online</div>
              </div>
            </div>
            <div class="connect-arrow">‚Üí</div>
          `;
          
          list.appendChild(card);
        });
      }

      function connectToUser(username) {
        fr = username;
        hide("select");
        show("chatbox");
        
        loadHistory(fr);
        ws.send(JSON.stringify({ type: "check-online", friend: fr }));
      }

      async function makeOffer(to) {
        pc = new RTCPeerConnection(ice);
        iceQueue = [];
        dc = pc.createDataChannel("chat");
        setupDC();

        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("audio", { direction: "recvonly" });

        pc.ontrack = (e) => {
          const video = document.getElementById("v");
          video.srcObject = e.streams[0];
          video.muted = false;
          video.volume = 1.0;
          document.getElementById("vid").classList.add("on");
          document.getElementById("tag").textContent = "üîπ " + to;
        };

        pc.onicecandidate = (e) => {
          if (e.candidate) ws.send(JSON.stringify({ type: "ice-candidate", candidate: e.candidate, to }));
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", offer, to, from: me }));
      }

      async function getOffer(offer, from) {
        hide("select");
        show("chatbox");
        document.getElementById("stat").innerHTML = '<span class="green">‚úÖ Connecting with ' + from + "...</span>";

        loadHistory(from);

        pc = new RTCPeerConnection(ice);
        iceQueue = [];

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: true,
          });

          stream.getTracks().forEach((t) => pc.addTrack(t, stream));
          document.getElementById("camctrl").classList.remove("hide");
          console.log("‚úÖ Camera accessed");
        } catch (e) {
          console.error("Camera error:", e);
          alert("‚ùå Camera not available. Video won't work.\n\nMake sure:\n‚Ä¢ You allowed camera permission\n‚Ä¢ Page is using HTTPS\n‚Ä¢ Camera is not used by another app");
        }

        pc.ondatachannel = (e) => {
          dc = e.channel;
          setupDC();
        };
        
        pc.onicecandidate = (e) => {
          if (e.candidate) ws.send(JSON.stringify({ type: "ice-candidate", candidate: e.candidate, to: from }));
        };

        await pc.setRemoteDescription(offer);
        iceQueue.forEach((c) => pc.addIceCandidate(new RTCIceCandidate(c)).catch((e) => console.log(e)));
        iceQueue = [];

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer, to: from, from: me }));
      }

      async function getAnswer(answer) {
        await pc.setRemoteDescription(answer);
        iceQueue.forEach((c) => pc.addIceCandidate(new RTCIceCandidate(c)).catch((e) => console.log(e)));
        iceQueue = [];
      }

      function setupDC() {
        dc.onopen = () => {
          console.log("‚úÖ Connected");
          document.getElementById("stat").innerHTML = '<span class="green">‚úÖ Connected with ' + fr + "</span>";
        };
        dc.onmessage = (e) => {
          msg(e.data, "rcv", fr);
          if (navigator.vibrate) navigator.vibrate(50);
        };
        dc.onclose = () => document.getElementById("stat").innerHTML = '<span class="red">‚≠ï Disconnected</span>';
      }

      function send() {
        const input = document.getElementById("txt");
        const t = input.value.trim();
        if (!t || !dc || dc.readyState !== "open") return;

        dc.send(t);
        msg(t, "sent", "You");
        input.value = "";
        input.focus();
      }

      function msg(txt, type, name) {
        displayMessage(txt, type, name, Date.now(), true);
      }

      function displayMessage(txt, type, name, timestamp, saveToHistory) {
        const m = document.createElement("div");
        m.className = "m " + type;
        const time = new Date(timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        m.innerHTML = "<strong>" + name + '</strong><span class="txt">' + esc(txt) + '</span><span class="time">' + time + "</span>";

        const chat = document.getElementById("msgs");
        chat.appendChild(m);
        chat.scrollTop = chat.scrollHeight;

        if (saveToHistory && fr) {
          saveMessage(fr, txt, type);
        }
      }

      function stopCam() {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
          document.getElementById("camctrl").classList.add("hide");
          alert("Camera stopped");
        }
      }

      function disc() {
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
        document.getElementById("vid").classList.remove("on");
        document.getElementById("msgs").innerHTML = "";
        document.getElementById("historyInfo").classList.add("hide");
        hide("chatbox");
        show("select");
        
        // Refresh online users when returning
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "get-online-users" }));
        }
      }

      function hide(id) {
        document.getElementById(id).classList.add("hide");
      }
      
      function show(id) {
        document.getElementById(id).classList.remove("hide");
      }
      
      function esc(t) {
        const d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
      }

      window.onbeforeunload = () => {
        if (ws) ws.close();
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
        clearInterval(refreshInterval);
      };
    </script>
  </body>
</html>