<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WebRTC Secure Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .box {
        background: #fff;
        width: 100%;
        max-width: 650px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .head {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        padding: 20px;
        text-align: center;
      }
      .head h1 {
        font-size: 22px;
      }
      .head p {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 5px;
      }
      .content {
        padding: 20px;
      }
      input {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        margin-bottom: 10px;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        transition: transform 0.2s;
      }
      button:active {
        transform: scale(0.98);
      }
      button.gray {
        background: #6c757d;
      }
      button.red {
        background: #dc3545;
      }
      button.small {
        width: auto;
        padding: 8px 16px;
        font-size: 13px;
        margin: 0;
      }
      .status {
        padding: 14px;
        background: #f0f2f5;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 14px;
      }
      .green {
        color: #28a745;
        font-weight: 600;
      }
      .red {
        color: #dc3545;
        font-weight: 600;
      }
      .video {
        background: #000;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        display: none;
      }
      .video.on {
        display: block;
      }
      .video video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      .tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(102, 126, 234, 0.95);
        color: #fff;
        padding: 8px 14px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 600;
        z-index: 10;
      }
      .chat {
        background: #f0f2f5;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .date-sep {
        text-align: center;
        color: #666;
        font-size: 12px;
        margin: 10px 0;
        font-weight: 600;
      }
      .m {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
        animation: slide 0.3s ease;
      }
      @keyframes slide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .m.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .m.rcv {
        align-self: flex-start;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        border-bottom-left-radius: 4px;
        color: #333;
      }
      .m strong {
        display: block;
        font-size: 12px;
        margin-bottom: 4px;
        opacity: 0.85;
      }
      .m .txt {
        display: block;
      }
      .m .time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }
      .inbox {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .inbox input {
        margin: 0;
        flex: 1;
      }
      .inbox button {
        width: 50px;
        height: 50px;
        min-width: 50px;
        border-radius: 50%;
        padding: 0;
        font-size: 20px;
      }
      .hide {
        display: none;
      }
      .users {
        margin-top: 15px;
      }
      .user {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .user:hover {
        background: #e9ecef;
      }
      .user button {
        width: auto;
        padding: 8px 16px;
        font-size: 13px;
        margin: 0;
      }
      .info {
        font-size: 12px;
        padding: 12px;
        background: #fff3cd;
        border-radius: 8px;
        margin-bottom: 10px;
        text-align: center;
        color: #856404;
        line-height: 1.6;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 2px solid #66bb6a;
      }
      .ctrl {
        display: none;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: center;
      }
      .ctrl button {
        width: auto;
        padding: 10px 16px;
      }
      .history-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 12px;
        color: #1565c0;
      }
      .history-info button {
        background: #1976d2;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
      }
      @media (max-width: 600px) {
        .box {
          max-width: 100%;
        }
        .chat {
          height: 300px;
        }
        .m {
          max-width: 85%;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div class="head">
        <h1>üöÄ WebRTC Secure Chat</h1>
        <p>üîí End-to-End Encrypted ‚Ä¢ Chat History Saved</p>
      </div>
      <div class="content">
        <div id="login">
          <input
            type="text"
            id="user"
            placeholder="Your username (e.g., john123)"
          />
          <button onclick="login()">Connect to Server</button>
          <div class="info">
            üí° Chat history is saved securely on your device
          </div>
        </div>

        <div id="select" class="hide">
          <div class="status">
            <span class="green">‚úÖ You're Online as <b id="me"></b></span>
          </div>
          <input
            type="text"
            id="friend"
            placeholder="Enter friend's username"
          />
          <button onclick="connect()">Check & Connect</button>
          <div id="userlist" class="users hide"></div>
        </div>

        <div id="chatbox" class="hide">
          <div class="status" id="stat">‚è≥ Connecting...</div>

          <div id="historyInfo" class="history-info hide">
            <span>üíæ <b id="msgCount">0</b> messages saved</span>
            <button onclick="clearHistory()">Clear History</button>
          </div>

          <div id="vid" class="video">
            <video id="v" autoplay playsinline muted></video>
            <div class="tag" id="tag">üìπ Live</div>
          </div>

          <div id="camctrl" class="ctrl hide">
            <button onclick="stopCam()" class="red">‚èπ Stop Camera</button>
          </div>

          <div class="chat" id="msgs"></div>
          <div class="inbox">
            <input
              type="text"
              id="txt"
              placeholder="Type a message..."
              onkeypress="if(event.key==='Enter')send()"
            />
            <button onclick="send()">‚û§</button>
          </div>
          <button class="gray" onclick="disc()" style="margin-top: 10px">
            Disconnect
          </button>
        </div>
      </div>
    </div>

    <script>
      let ws,
        pc,
        dc,
        me,
        fr,
        stream,
        iceQueue = [];

      const ice = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      const wsUrl = (() => {
        const isLocal =
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1";
        if (isLocal) return "ws://localhost:8080";
        const proto = location.protocol === "https:" ? "wss" : "ws";
        return `${proto}://${location.host}`;
      })();

      // Simple AES-like encryption for chat history [web:120][web:123]
      function simpleEncrypt(text, key) {
        let result = "";
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(
            text.charCodeAt(i) ^ key.charCodeAt(i % key.length)
          );
        }
        return btoa(result);
      }

      function simpleDecrypt(encrypted, key) {
        try {
          const decoded = atob(encrypted);
          let result = "";
          for (let i = 0; i < decoded.length; i++) {
            result += String.fromCharCode(
              decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length)
            );
          }
          return result;
        } catch (e) {
          return null;
        }
      }

      // Generate device-specific encryption key [web:123]
      function getEncryptionKey() {
        let key = localStorage.getItem("_ek");
        if (!key) {
          key =
            Math.random().toString(36).substring(2) + Date.now().toString(36);
          localStorage.setItem("_ek", key);
        }
        return key;
      }

      const encKey = getEncryptionKey();

      // Save message to history [web:120]
      function saveMessage(friend, message, type) {
        const chatKey = `chat_${me}_${friend}`;
        let history = [];

        try {
          const stored = localStorage.getItem(chatKey);
          if (stored) {
            const decrypted = simpleDecrypt(stored, encKey);
            if (decrypted) history = JSON.parse(decrypted);
          }
        } catch (e) {
          console.log("History load error");
        }

        history.push({
          msg: message,
          type: type,
          time: Date.now(),
        });

        // Keep only last 500 messages to avoid storage limits [web:126]
        if (history.length > 500) history = history.slice(-500);

        try {
          const encrypted = simpleEncrypt(JSON.stringify(history), encKey);
          localStorage.setItem(chatKey, encrypted);
        } catch (e) {
          console.log("History save error");
        }

        updateMessageCount();
      }

      // Load chat history [web:120]
      function loadHistory(friend) {
        const chatKey = `chat_${me}_${friend}`;

        try {
          const stored = localStorage.getItem(chatKey);
          if (!stored) return;

          const decrypted = simpleDecrypt(stored, encKey);
          if (!decrypted) return;

          const history = JSON.parse(decrypted);

          if (history.length > 0) {
            // Show date separator
            const sep = document.createElement("div");
            sep.className = "date-sep";
            sep.textContent = "üìú Previous Messages";
            document.getElementById("msgs").appendChild(sep);

            // Show last 50 messages [web:126]
            const recent = history.slice(-50);
            recent.forEach((item) => {
              displayMessage(
                item.msg,
                item.type,
                item.type === "sent" ? "You" : friend,
                item.time,
                false
              );
            });

            // Another separator for new messages
            const sep2 = document.createElement("div");
            sep2.className = "date-sep";
            sep2.textContent = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ New Messages ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
            document.getElementById("msgs").appendChild(sep2);
          }

          updateMessageCount();
        } catch (e) {
          console.log("History load failed");
        }
      }

      // Update message counter
      function updateMessageCount() {
        if (!me || !fr) return;
        const chatKey = `chat_${me}_${fr}`;

        try {
          const stored = localStorage.getItem(chatKey);
          if (stored) {
            const decrypted = simpleDecrypt(stored, encKey);
            if (decrypted) {
              const history = JSON.parse(decrypted);
              document.getElementById("msgCount").textContent = history.length;
              document.getElementById("historyInfo").classList.remove("hide");
            }
          }
        } catch (e) {}
      }

      // Clear chat history
      function clearHistory() {
        if (
          !confirm(
            "Delete all chat history with " + fr + "?\n\nThis cannot be undone!"
          )
        )
          return;

        const chatKey = `chat_${me}_${fr}`;
        localStorage.removeItem(chatKey);

        // Clear displayed messages
        const msgs = document.getElementById("msgs");
        msgs.innerHTML = "";

        document.getElementById("msgCount").textContent = "0";
        alert("‚úÖ Chat history deleted");
      }

      function login() {
        me = document.getElementById("user").value.trim().toLowerCase();
        if (!me) return alert("Enter username");

        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          console.log("‚úÖ Connected");
          ws.send(JSON.stringify({ type: "register", username: me }));
        };
        ws.onmessage = handle;
        ws.onerror = () => alert("‚ùå Cannot connect to server");
        ws.onclose = () => console.log("Disconnected");
      }

      function handle(e) {
        const d = JSON.parse(e.data);

        if (d.type === "registered") {
          hide("login");
          show("select");
          document.getElementById("me").textContent = me;
          ws.send(JSON.stringify({ type: "get-online-users" }));
        } else if (d.type === "status") {
          if (d.online) {
            document.getElementById("stat").innerHTML =
              '<span class="green">‚úÖ ' +
              d.friend +
              " is online - connecting...</span>";
            makeOffer(d.friend);
          } else {
            document.getElementById("stat").innerHTML =
              '<span class="red">‚≠ï ' + d.friend + " is offline</span>";
            setTimeout(() => alert(d.friend + " is not online"), 100);
          }
        } else if (d.type === "offer") {
          fr = d.from;
          getOffer(d.offer, d.from);
        } else if (d.type === "answer") getAnswer(d.answer);
        else if (d.type === "ice-candidate") {
          if (pc) {
            if (pc.remoteDescription) {
              pc.addIceCandidate(new RTCIceCandidate(d.candidate)).catch((e) =>
                console.log("ICE:", e)
              );
            } else {
              iceQueue.push(d.candidate);
            }
          }
        } else if (d.type === "online-users") showUsers(d.users);
      }

      function connect() {
        fr = document.getElementById("friend").value.trim().toLowerCase();
        if (!fr) return alert("Enter friend username");
        if (fr === me) return alert("Cannot connect to yourself!");

        hide("select");
        show("chatbox");

        // Load previous chat history [web:120]
        loadHistory(fr);

        ws.send(JSON.stringify({ type: "check-online", friend: fr }));
      }

      async function makeOffer(to) {
        pc = new RTCPeerConnection(ice);
        iceQueue = [];
        dc = pc.createDataChannel("chat");
        setupDC();

        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("audio", { direction: "recvonly" });

        pc.ontrack = (e) => {
          document.getElementById("v").srcObject = e.streams[0];
          document.getElementById("vid").classList.add("on");
          document.getElementById("tag").textContent = "üìπ " + to;
        };

        pc.onicecandidate = (e) => {
          if (e.candidate)
            ws.send(
              JSON.stringify({
                type: "ice-candidate",
                candidate: e.candidate,
                to,
              })
            );
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", offer, to, from: me }));
      }

      async function getOffer(offer, from) {
        hide("select");
        show("chatbox");
        document.getElementById("stat").innerHTML =
          '<span class="green">‚úÖ Connecting with ' + from + "...</span>";

        // Load previous chat history
        loadHistory(from);

        pc = new RTCPeerConnection(ice);
        iceQueue = [];

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
            audio: true,
          });

          stream.getTracks().forEach((t) => pc.addTrack(t, stream));
          document.getElementById("camctrl").classList.remove("hide");
          console.log("‚úÖ Camera accessed");
        } catch (e) {
          console.error("Camera error:", e);
          alert(
            "‚ùå Camera not available. Video won't work.\n\nMake sure:\n‚Ä¢ You allowed camera permission\n‚Ä¢ Page is using HTTPS\n‚Ä¢ Camera is not used by another app"
          );
        }

        pc.ondatachannel = (e) => {
          dc = e.channel;
          setupDC();
        };
        pc.onicecandidate = (e) => {
          if (e.candidate)
            ws.send(
              JSON.stringify({
                type: "ice-candidate",
                candidate: e.candidate,
                to: from,
              })
            );
        };

        await pc.setRemoteDescription(offer);
        iceQueue.forEach((c) =>
          pc
            .addIceCandidate(new RTCIceCandidate(c))
            .catch((e) => console.log(e))
        );
        iceQueue = [];

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer, to: from, from: me }));
      }

      async function getAnswer(answer) {
        await pc.setRemoteDescription(answer);
        iceQueue.forEach((c) =>
          pc
            .addIceCandidate(new RTCIceCandidate(c))
            .catch((e) => console.log(e))
        );
        iceQueue = [];
      }

      function setupDC() {
        dc.onopen = () => {
          console.log("‚úÖ Connected - Messages encrypted with DTLS [web:125]");
          document.getElementById("stat").innerHTML =
            '<span class="green">‚úÖ Connected with ' + fr + "</span>";
        };
        dc.onmessage = (e) => {
          msg(e.data, "rcv", fr);
          if (navigator.vibrate) navigator.vibrate(50);
        };
        dc.onclose = () =>
          (document.getElementById("stat").innerHTML =
            '<span class="red">‚≠ï Disconnected</span>');
      }

      function send() {
        const input = document.getElementById("txt");
        const t = input.value.trim();
        if (!t || !dc || dc.readyState !== "open") return;

        dc.send(t);
        msg(t, "sent", "You");
        input.value = "";
        input.focus();
      }

      function msg(txt, type, name) {
        displayMessage(txt, type, name, Date.now(), true);
      }

      function displayMessage(txt, type, name, timestamp, saveToHistory) {
        const m = document.createElement("div");
        m.className = "m " + type;
        const time = new Date(timestamp).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        m.innerHTML =
          "<strong>" +
          name +
          '</strong><span class="txt">' +
          esc(txt) +
          '</span><span class="time">' +
          time +
          "</span>";

        const chat = document.getElementById("msgs");
        chat.appendChild(m);
        chat.scrollTop = chat.scrollHeight;

        // Save to encrypted history [web:120]
        if (saveToHistory && fr) {
          saveMessage(fr, txt, type);
        }
      }

      function showUsers(users) {
        const list = document.getElementById("userlist");
        if (users.length === 0) {
          list.classList.add("hide");
          return;
        }
        list.classList.remove("hide");
        list.innerHTML =
          '<h3 style="font-size:15px;margin:15px 0 10px">Online (' +
          users.length +
          "):</h3>";
        users.forEach((u) => {
          const div = document.createElement("div");
          div.className = "user";
          div.innerHTML =
            '<span><span style="color:#28a745">‚óè</span> ' +
            u +
            "</span><button onclick=\"quick('" +
            u +
            "')\">Connect</button>";
          list.appendChild(div);
        });
      }

      function quick(u) {
        document.getElementById("friend").value = u;
        connect();
      }

      function stopCam() {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
          document.getElementById("camctrl").classList.add("hide");
          alert("Camera stopped");
        }
      }

      function disc() {
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
        document.getElementById("vid").classList.remove("on");
        document.getElementById("msgs").innerHTML = "";
        document.getElementById("historyInfo").classList.add("hide");
        hide("chatbox");
        show("select");
        ws.send(JSON.stringify({ type: "get-online-users" }));
      }

      function hide(id) {
        document.getElementById(id).classList.add("hide");
      }
      function show(id) {
        document.getElementById(id).classList.remove("hide");
      }
      function esc(t) {
        const d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
      }

      window.onbeforeunload = () => {
        if (ws) ws.close();
        if (pc) pc.close();
        if (stream) stream.getTracks().forEach((t) => t.stop());
      };
    </script>
  </body>
</html>
