<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-User Video Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1200px; overflow: hidden; }
        .login-screen { padding: 60px 40px; text-align: center; }
        .login-screen h1 { color: #667eea; margin-bottom: 30px; font-size: 2.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; text-align: left; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .radio-group { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; }
        .radio-group label:hover { border-color: #667eea; background: #f5f5ff; }
        .radio-group input[type="radio"]:checked + span { color: #667eea; font-weight: 600; }
        .btn { padding: 14px 40px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: #ff4757; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .lobby-screen { display: flex; height: 600px; }
        .sidebar { width: 300px; background: #f8f9fa; border-right: 2px solid #e0e0e0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-header h2 { font-size: 1.3em; margin-bottom: 5px; }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .user-item:hover { border-color: #667eea; transform: translateX(5px); }
        .user-item.online { border-left: 4px solid #2ecc71; }
        .waiting-message { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; padding: 40px; text-align: center; }
        .waiting-message h2 { color: #667eea; margin-bottom: 20px; }
        .queue-info { background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .chat-screen { display: flex; height: 600px; }
        .video-section { width: 400px; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .no-video-message { color: white; text-align: center; padding: 20px; }
        .stream-status { position: absolute; top: 10px; right: 10px; padding: 8px 12px; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 5px; font-size: 0.8em; z-index: 10; }
        .stream-status.streaming { background: rgba(40, 167, 69, 0.8); }
        .stream-status.stopped { background: rgba(220, 53, 69, 0.8); }
        #remoteCanvas, #localVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { display: none; }
        .chat-section { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message.self { align-items: flex-end; }
        .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 12px; word-wrap: break-word; }
        .message.self .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .message.other .message-bubble { background: white; color: #333; }
        .message-sender { font-size: 0.8em; color: #666; margin-bottom: 4px; }
        .message-time { font-size: 0.75em; color: #999; margin-top: 4px; }
        .message-input { display: flex; padding: 20px; background: white; border-top: 2px solid #e0e0e0; }
        .message-input input { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-right: 10px; }
        .message-input input:focus { outline: none; border-color: #667eea; }
        .hidden { display: none !important; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .status-online { background: #d4edda; color: #155724; }
        .fps-counter { position: absolute; top: 10px; left: 10px; padding: 4px 8px; background: rgba(0, 0, 0, 0.5); color: white; font-size: 0.7em; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginScreen" class="login-screen">
            <h1>üé• Video Chat Platform</h1>
            <div class="form-group">
                <label>Your Name</label>
                <input type="text" id="usernameInput" placeholder="Enter your name">
            </div>
            <div class="radio-group">
                <label>
                    <input type="radio" name="userType" value="user" checked>
                    <span>User</span>
                </label>
                <label>
                    <input type="radio" name="userType" value="admin">
                    <span>Admin</span>
                </label>
            </div>
            <div class="form-group hidden" id="passwordGroup">
                <label>Admin Password</label>
                <input type="password" id="passwordInput" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Join</button>
        </div>

        <div id="lobbyScreen" class="lobby-screen hidden">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2 id="lobbyTitle">Lobby</h2>
                    <p id="lobbyUsername"></p>
                    <button class="btn btn-danger" style="margin-top: 10px; width: 100%;" onclick="logout()">Logout</button>
                </div>
                <div class="user-list" id="userList"></div>
            </div>
            <div class="waiting-message" id="waitingArea">
                <h2>üëã Welcome!</h2>
                <p id="waitingText">Waiting for connection...</p>
                <div id="queueInfo" class="queue-info hidden">
                    <strong>Queue Position:</strong> <span id="queuePosition">-</span>
                </div>
            </div>
        </div>

        <div id="chatScreen" class="chat-screen hidden">
            <div class="video-section" id="videoSection">
                <div class="stream-status" id="streamStatus">‚è∏Ô∏è Stopped</div>
                <div class="fps-counter" id="fpsCounter">0 FPS</div>
                <canvas id="remoteCanvas"></canvas>
                <video id="localVideo" autoplay muted playsinline></video>
                <canvas id="captureCanvas" style="display: none;"></canvas>
                <div class="no-video-message" id="noVideoMessage">
                    <h3>üìπ Video Feed</h3>
                    <p>Waiting for user's video stream...</p>
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-header">
                    <div>
                        <h3 id="chatWith">Chat</h3>
                        <span class="status-badge status-online">Online</span>
                    </div>
                    <button class="btn btn-danger" onclick="endChat()">End Chat</button>
                </div>
                <div class="messages" id="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-success" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "admin123";
        const WS_URL = "wss://wechat-xhvo.onrender.com";
        const FPS = 8; // Frames per second (adjust for quality vs bandwidth)
        const JPEG_QUALITY = 0.5; // 0.1 to 1.0 (higher = better quality, more bandwidth)
        const MESSAGE_PRIORITY_PAUSE = 300; // Pause video frames for 200ms when sending message

        let ws = null;
        let currentUser = { id: null, username: "", type: "user" };
        let selectedUser = null;
        let messages = [];
        let localStream = null;
        let streamingInterval = null;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let isMessageBeingSent = false; // Flag to pause video frames
        let frameQueue = []; // Queue for video frames
        let frameQueueInterval = null;

        const loginScreen = document.getElementById("loginScreen");
        const lobbyScreen = document.getElementById("lobbyScreen");
        const chatScreen = document.getElementById("chatScreen");
        const usernameInput = document.getElementById("usernameInput");
        const passwordInput = document.getElementById("passwordInput");
        const passwordGroup = document.getElementById("passwordGroup");
        const userList = document.getElementById("userList");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const localVideo = document.getElementById("localVideo");
        const captureCanvas = document.getElementById("captureCanvas");
        const remoteCanvas = document.getElementById("remoteCanvas");
        const videoSection = document.getElementById("videoSection");
        const noVideoMessage = document.getElementById("noVideoMessage");
        const streamStatus = document.getElementById("streamStatus");
        const fpsCounter = document.getElementById("fpsCounter");

        document.querySelectorAll('input[name="userType"]').forEach(radio => {
            radio.addEventListener("change", (e) => {
                if (e.target.value === "admin") {
                    passwordGroup.classList.remove("hidden");
                } else {
                    passwordGroup.classList.add("hidden");
                }
            });
        });

        function handleLogin() {
            const username = usernameInput.value.trim();
            const userType = document.querySelector('input[name="userType"]:checked').value;
            const password = passwordInput.value;

            if (!username) {
                alert("Please enter your name");
                return;
            }

            if (userType === "admin" && password !== ADMIN_PASSWORD) {
                alert("Incorrect admin password");
                return;
            }

            currentUser.username = username;
            currentUser.type = userType;
            connectWebSocket();
        }

        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log("‚úÖ Connected to server");
                ws.send(JSON.stringify({
                    type: "join",
                    username: currentUser.username,
                    userType: currentUser.type
                }));
                showLobby();
            };

            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                }
            };

            ws.onclose = () => console.log("‚ùå Disconnected from server");
            ws.onerror = (error) => {
                console.error("‚ùå WebSocket error:", error);
                alert("Connection error. Please check if the server is running.");
            };
        }

        function handleWebSocketMessage(data) {
            console.log("üì® Received:", data.type);
            
            switch (data.type) {
                case "welcome":
                    currentUser.id = data.userId;
                    console.log("üë§ User ID:", currentUser.id);
                    break;
                case "userList":
                    updateUserList(data.users);
                    break;
                case "queuePosition":
                    updateQueuePosition(data.position);
                    break;
                case "chatStarted":
                    startChat(data.with, data.messages);
                    break;
                case "message":
                    receiveMessage(data);
                    break;
                case "chatEnded":
                    handleChatEnded(data);
                    break;
                case "videoFrame":
                    displayVideoFrame(data.frame);
                    break;
                case "startVideoStream":
                    if (currentUser.type === "user") {
                        console.log("üìπ Admin requested video stream");
                        startVideoStream();
                    }
                    break;
                case "stopVideoStream":
                    if (currentUser.type === "user") {
                        console.log("‚è∏Ô∏è Admin stopped video stream");
                        stopVideoStream();
                    }
                    break;
                case "error":
                    alert(data.message);
                    break;
            }
        }

        function showLobby() {
            loginScreen.classList.add("hidden");
            lobbyScreen.classList.remove("hidden");
            chatScreen.classList.add("hidden");

            document.getElementById("lobbyTitle").textContent = 
                currentUser.type === "admin" ? "Admin Lobby" : "User Lobby";
            document.getElementById("lobbyUsername").textContent = 
                `Logged in as: ${currentUser.username}`;

            if (currentUser.type === "user") {
                document.getElementById("waitingText").textContent = "Waiting for admin to connect...";
            } else {
                document.getElementById("waitingText").textContent = "Select a user to start chatting";
            }
        }

        function updateUserList(users) {
            if (currentUser.type !== "admin") return;

            userList.innerHTML = "";
            users.forEach(user => {
                if (user.type === "user") {
                    const userItem = document.createElement("div");
                    userItem.className = "user-item online";
                    userItem.innerHTML = `
                        <strong>${user.username}</strong>
                        <div style="font-size: 0.8em; color: #666;">Click to chat</div>
                    `;
                    userItem.onclick = () => selectUser(user);
                    userList.appendChild(userItem);
                }
            });

            if (userList.children.length === 0) {
                userList.innerHTML = "<p style='padding: 20px; text-align: center; color: #999;'>No users online</p>";
            }
        }

        function updateQueuePosition(position) {
            if (currentUser.type !== "user") return;

            const queueInfo = document.getElementById("queueInfo");
            const queuePosition = document.getElementById("queuePosition");

            if (position > 0) {
                queueInfo.classList.remove("hidden");
                queuePosition.textContent = position;
            } else {
                queueInfo.classList.add("hidden");
            }
        }

        function selectUser(user) {
            if (currentUser.type !== "admin") return;

            console.log("üë§ Admin selecting user:", user.username);
            ws.send(JSON.stringify({
                type: "selectUser",
                userId: user.id
            }));
        }

        function startChat(user, chatMessages) {
            selectedUser = user;
            messages = chatMessages || [];

            lobbyScreen.classList.add("hidden");
            chatScreen.classList.remove("hidden");

            document.getElementById("chatWith").textContent = `Chatting with ${user.username}`;

            displayMessages();

            if (currentUser.type === "admin") {
                videoSection.classList.remove("hidden");
                noVideoMessage.classList.remove("hidden");
                
                // Setup canvas for receiving frames
                const ctx = remoteCanvas.getContext('2d');
                remoteCanvas.width = 640;
                remoteCanvas.height = 480;
                
                setTimeout(() => {
                    console.log("üìπ Requesting video stream from user...");
                    ws.send(JSON.stringify({
                        type: "startVideoStream",
                        userId: user.id
                    }));
                }, 1000);
            } else {
                videoSection.classList.add("hidden");
            }
        }

        function displayMessages() {
            messagesDiv.innerHTML = "";
            messages.forEach(msg => addMessageToUI(msg));
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageToUI(msg) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${msg.from === currentUser.username ? 'self' : 'other'}`;

            const time = new Date(msg.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            messageDiv.innerHTML = `
                <div class="message-sender">${msg.from}</div>
                <div class="message-bubble">${escapeHtml(msg.text)}</div>
                <div class="message-time">${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !ws) return;

            // PRIORITY: Pause video frames when sending message
            isMessageBeingSent = true;

            const message = {
                type: "message",
                text: text,
                to: selectedUser.id,
                priority: true // Mark as high priority
            };

            // Send message immediately
            ws.send(JSON.stringify(message));

            const msg = {
                from: currentUser.username,
                text: text,
                timestamp: new Date().toISOString()
            };

            messages.push(msg);
            addMessageToUI(msg);
            messageInput.value = "";

            // Resume video frames after delay
            setTimeout(() => {
                isMessageBeingSent = false;
            }, MESSAGE_PRIORITY_PAUSE);

            console.log("üí¨ Message sent with priority");
        }

        function receiveMessage(data) {
            const msg = {
                from: data.from,
                text: data.text,
                timestamp: data.timestamp
            };

            messages.push(msg);
            addMessageToUI(msg);
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        function endChat() {
            ws.send(JSON.stringify({
                type: "endChat",
                userId: selectedUser?.id
            }));

            cleanupChat();
            showLobby();
        }

        function handleChatEnded(data) {
            cleanupChat();
            showLobby();

            if (currentUser.type === "user" && data.queuePosition) {
                updateQueuePosition(data.queuePosition);
            }
        }

        function cleanupChat() {
            selectedUser = null;
            messages = [];
            stopVideoStream();
        }

        function logout() {
            if (ws) ws.close();
            cleanupChat();
            currentUser = { id: null, username: "", type: "user" };
            usernameInput.value = "";
            passwordInput.value = "";
            loginScreen.classList.remove("hidden");
            lobbyScreen.classList.add("hidden");
            chatScreen.classList.add("hidden");
        }

        // ====== FRAME STREAMING VIDEO FUNCTIONS ======

        async function startVideoStream() {
            console.log("üé• Starting frame streaming...");
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user"
                    }, 
                    audio: false // We'll handle audio separately if needed
                });

                localVideo.srcObject = localStream;
                await localVideo.play();

                console.log("‚úÖ Camera access granted");

                // Setup capture canvas
                captureCanvas.width = 640;
                captureCanvas.height = 480;

                updateStreamStatus("streaming");

                // Start capturing and sending frames
                streamingInterval = setInterval(() => {
                    captureAndSendFrame();
                }, 1000 / FPS);

                // Start frame queue processor (sends frames smoothly)
                frameQueueInterval = setInterval(() => {
                    processFrameQueue();
                }, 50); // Process queue every 50ms

                console.log(`üìπ Streaming at ${FPS} FPS with message priority`);

            } catch (error) {
                console.error("‚ùå Error accessing camera:", error);
                alert("Could not access camera. Please check permissions.");
            }
        }

        function captureAndSendFrame() {
            if (!localStream || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            // PRIORITY: Skip frame if message is being sent
            if (isMessageBeingSent) {
                console.log("‚è∏Ô∏è Skipping frame - message priority");
                return;
            }

            const ctx = captureCanvas.getContext('2d');
            
            // Draw current video frame to canvas
            ctx.drawImage(localVideo, 0, 0, captureCanvas.width, captureCanvas.height);
            
            // Convert canvas to JPEG base64
            const frameData = captureCanvas.toDataURL('image/jpeg', JPEG_QUALITY);
            
            // Queue the frame instead of sending immediately
            frameQueue.push({
                type: "videoFrame",
                frame: frameData,
                to: selectedUser.id,
                priority: false // Low priority
            });

            // Update FPS counter
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                fpsCounter.textContent = `${frameCount} FPS`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        // Process frame queue - sends frames one at a time
        function processFrameQueue() {
            if (frameQueue.length > 0 && !isMessageBeingSent && ws && ws.readyState === WebSocket.OPEN) {
                // Keep only the latest 2 frames to prevent queue buildup
                if (frameQueue.length > 2) {
                    frameQueue = frameQueue.slice(-2);
                }

                const frame = frameQueue.shift();
                ws.send(JSON.stringify(frame));
            }
        }

        function displayVideoFrame(frameData) {
            if (currentUser.type !== "admin") return;

            const img = new Image();
            img.onload = () => {
                const ctx = remoteCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0, remoteCanvas.width, remoteCanvas.height);
                noVideoMessage.classList.add("hidden");
                updateStreamStatus("streaming");

                // Update FPS counter
                frameCount++;
                const now = Date.now();
                if (now - lastFpsUpdate >= 1000) {
                    fpsCounter.textContent = `${frameCount} FPS`;
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
            };
            img.src = frameData;
        }

        function stopVideoStream() {
            console.log("üõë Stopping video stream...");
            
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }

            if (frameQueueInterval) {
                clearInterval(frameQueueInterval);
                frameQueueInterval = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    console.log("‚èπÔ∏è Stopped track:", track.kind);
                });
                localStream = null;
            }

            localVideo.srcObject = null;
            updateStreamStatus("stopped");
            frameCount = 0;
            fpsCounter.textContent = "0 FPS";
            frameQueue = []; // Clear frame queue
            isMessageBeingSent = false;

            if (currentUser.type === "admin") {
                noVideoMessage.classList.remove("hidden");
            }
        }

        function updateStreamStatus(status) {
            if (status === "streaming") {
                streamStatus.className = "stream-status streaming";
                streamStatus.textContent = "üî¥ Live";
            } else {
                streamStatus.className = "stream-status stopped";
                streamStatus.textContent = "‚è∏Ô∏è Stopped";
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.addEventListener("beforeunload", () => {
            if (ws) ws.close();
            stopVideoStream();
        });
    </script>
</body>
</html>